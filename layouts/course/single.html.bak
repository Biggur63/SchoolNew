{{ define "main" }}
<div class="container mx-auto px-4 py-8">
  <a href="{{ "/courses/" | relURL }}" class="inline-block text-sm mb-4 hover:underline">&larr; Все курсы</a>

  <header class="mb-6">
    <h1 class="text-3xl font-bold mb-2">{{ .Title }}</h1>

    {{ with .Params.summary }}
      <p class="text-gray-700 mb-4">{{ . }}</p>
    {{ else }}
      {{ if .Summary }}
        <p class="text-gray-700 mb-4">{{ .Summary }}</p>
      {{ end }}
    {{ end }}

    {{ with .Params.duration }}
      <p class="text-sm text-gray-500">Длительность: {{ . }}</p>
    {{ end }}
  </header>

  {{/* Текущая страница (курс) */}}
  {{ $page := . }}
  {{ $courseDir := $page.File.Dir }}
  {{ $parts := split $courseDir "/" }}
  {{ $courseKey := index $parts (sub (len $parts) 1) }}

  {{ $allowExternal := false }}
  {{ with $page.Params.allow_external_modules }}
    {{ $allowExternal = . }}
  {{ end }}

  {{ $collected := slice }}
  {{ $perms := slice }}

  {{/* 1) Явный список modules из frontmatter */}}
  {{ with $page.Params.modules }}
    {{ range . }}
      {{ $item := . | urlize }}
      {{ $p := $.Site.GetPage (printf "courses/%s/%s" $courseKey $item) }}
      {{ if not $p }}
        {{ $p = $.Site.GetPage (printf "courses/%s" $item) }}
      {{ end }}
      {{ if not $p }}
        {{ $p = $.Site.GetPage (printf "modules/%s" $item) }}
        {{ if $p }}
          {{/* разрешаем внешний модуль только если он явно связан с курсом или allowExternal=true */}}
          {{ $ok := false }}
          {{ with $p.Params.course }}
            {{ if eq . $courseKey }}
              {{ $ok = true }}
            {{ end }}
          {{ end }}
          {{ if $allowExternal }}
            {{ $ok = true }}
          {{ end }}
          {{ if not $ok }}
            {{ $p = nil }}
          {{ end }}
        {{ end }}
      {{ end }}

      {{ if $p }}
        {{ if ne $p.RelPermalink $page.RelPermalink }}
          {{ $perm := $p.RelPermalink }}
          {{ $exists := false }}
          {{ range $perms }} {{ if eq . $perm }} {{ $exists = true }} {{ end }} {{ end }}
          {{ if not $exists }}
            {{ $collected = $collected | append $p }}
            {{ $perms = $perms | append $perm }}
          {{ end }}
        {{ end }}
      {{ end }}
    {{ end }}
  {{ end }}

  {{/* 2) Дочерние страницы (RegularPages) — только локальные модули и не advanced */}}
  {{ $children := $page.RegularPages }}
  {{ if gt (len $children) 0 }}
    {{ range sort $children "Params.order" "asc" }}
      {{/* исключаем саму страницу и продвинутые модули */}}
      {{ if and (ne .RelPermalink $page.RelPermalink) (ne .Params.level "advanced") }}
        {{ $perm := .RelPermalink }}
        {{ $exists := false }}
        {{ range $perms }} {{ if eq . $perm }} {{ $exists = true }} {{ end }} {{ end }}
        {{ if not $exists }}
          {{ $collected = $collected | append . }}
          {{ $perms = $perms | append $perm }}
        {{ end }}
      {{ end }}
    {{ end }}
  {{ end }}

  {{/* 3) Если всё ещё пусто — fallback: искать в Site.RegularPages только те страницы, 
        чья .File.Dir начинается с $courseDir и которые не advanced */}}
  {{ if eq (len $collected) 0 }}
    {{ range $.Site.RegularPages }}
      {{ $fd := .File.Dir }}
      {{/* проверяем, что файл находится внутри директории курса (строгая проверка с hasPrefix) */}}
      {{ if and (hasPrefix $fd $courseDir) (ne .RelPermalink $page.RelPermalink) (ne .Params.level "advanced") }}
        {{ $perm := .RelPermalink }}
        {{ $exists := false }}
        {{ range $perms }} {{ if eq . $perm }} {{ $exists = true }} {{ end }} {{ end }}
        {{ if not $exists }}
          {{ $collected = $collected | append . }}
          {{ $perms = $perms | append $perm }}
        {{ end }}
      {{ end }}
    {{ end }}
  {{ end }}

  <section>
    <h2 class="text-2xl font-semibold mb-4">Модули курса</h2>

    {{ if eq (len $collected) 0 }}
      <p class="text-gray-600 mb-6">
        Для этого курса пока не найдено модулей. Проверьте, пожалуйста:
      </p>
      <ul class="list-disc ml-6 text-gray-600 mb-6">
        <li>Добавьте в frontmatter курса <code>modules:</code> с slug'ами модулей либо поместите модули как дочерние страницы в <code>content/courses/{{ $courseKey }}/&lt;slug&gt;/index.md</code>.</li>
        <li>Если модули находятся в <code>content/modules/</code>, укажите в каждом модуле <code>params.course: "{{ $courseKey }}"</code>, либо установите <code>allow_external_modules: true</code>.</li>
      </ul>
    {{ else }}
      <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
        {{ range sort $collected "Params.order" "asc" }}
          {{ partial "course-card.html" . }}
        {{ end }}
      </div>
    {{ end }}
  </section>

</div>
{{ end }}
